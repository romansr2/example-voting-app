- name: Deploy on VM
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd /home/azureuser/
            
            # 1. Замінюємо build на image (використовуємо '.*' для надійності)
            sed -i 's|build:.*vote|image: ${{ secrets.ACR_LOGIN_SERVER }}/vote:latest|g' docker-compose.yml
            sed -i 's|build:.*result|image: ${{ secrets.ACR_LOGIN_SERVER }}/result:latest|g' docker-compose.yml
            sed -i 's|build:.*worker|image: ${{ secrets.ACR_LOGIN_SERVER }}/worker:latest|g' docker-compose.yml
            
            # 2. Видаляємо контекст, щоб Docker не шукав папки
            sed -i '/context:/d' docker-compose.yml
            
            # 3. Перевіряємо, чи файл змінився (це з'явиться в логах GitHub)
            cat docker-compose.yml
            
            # 4. Логін в ACR та запуск
            az acr login --name ${{ secrets.ACR_NAME }}
            docker compose pull
            docker compose up -d --remove-orphans
