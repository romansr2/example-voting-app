name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ACR Login
        run: az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and Push Images
        run: |
          for service in vote result worker; do
            docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest ./$service
            docker push ${{ secrets.ACR_LOGIN_SERVER }}/$service:latest
          done

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose to VM
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_KEY }}
          source: "docker-compose.yml"
          target: "/home/azureuser/"

      - name: Deploy on VM
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VM_IP }}
          username: azureuser
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd /home/azureuser/
            
            # 1. ВИДАЛЯЄМО ВСЕ ЗАЙВЕ (build, context, target, і будь-які локальні шляхи з ./)
            # Ми видаляємо будь-який рядок, де є './', незалежно від лапок
            sed -i '/build:/d; /context:/d; /target:/d; /\.\//d' docker-compose.yml
            
            # 2. Очищаємо застарілі блоки volumes та healthcheck, які посилаються на відсутні файли
            sed -i '/volumes:/d' docker-compose.yml
            sed -i '/healthcheck:/,/start_period:/d' docker-compose.yml

            # 3. ВСТАВЛЯЄМО ОБРАЗИ ( image: )
            # Використовуємо ^ для точного пошуку назви сервісу на початку рядка
            sed -i 's/^  vote:/  vote:\n    image: ${{ secrets.ACR_LOGIN_SERVER }}\/vote:latest/' docker-compose.yml
            sed -i 's/^  result:/  result:\n    image: ${{ secrets.ACR_LOGIN_SERVER }}\/result:latest/' docker-compose.yml
            sed -i 's/^  worker:/  worker:\n    image: ${{ secrets.ACR_LOGIN_SERVER }}\/worker:latest/' docker-compose.yml

            # 4. ВІДНОВЛЮЄМО volumes тільки для бази даних (для збереження даних)
            # Шукаємо рядок з db-data і додаємо над ним заголовок volumes:
            sed -i '/"db-data:/i \    volumes:' docker-compose.yml

            # 5. ДІАГНОСТИКА: дивимось, що вийшло
            echo "--- ФІНАЛЬНА ПЕРЕВІРКА ФАЙЛУ ---"
            cat docker-compose.yml
            echo "--------------------------------"
            
            # 6. АВТОРИЗАЦІЯ ТА ЗАПУСК
            az acr login --name ${{ secrets.ACR_NAME }}
            sudo docker compose pull
            sudo docker compose up -d --remove-orphans
